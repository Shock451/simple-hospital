/*
 * CROP
 * dependancy: jQuery
 * author: Ognjen "Zmaj Džedaj" Božičković and Mat Steinlin
 */
(function(e,t){Croppic=function(e,t){var n=this;n.id=e;n.obj=$("#"+e);n.outputDiv=n.obj;n.options={uploadUrl:"",uploadData:{},cropUrl:"",cropData:{},outputUrlId:"",imgEyecandy:true,imgEyecandyOpacity:.2,zoomFactor:10,rotateFactor:5,doubleZoomControls:true,rotateControls:true,modal:false,customUploadButtonId:"",loaderHtml:"",scaleToFill:true,loadPicture:"",onReset:null,enableMousescroll:false,onBeforeImgUpload:null,onAfterImgUpload:null,onImgDrag:null,onImgZoom:null,onImgRotate:null,onBeforeImgCrop:null,onAfterImgCrop:null,onError:null};for(i in t)n.options[i]=t[i];n.init()};Croppic.prototype={id:"",imgInitW:0,imgInitH:0,imgW:0,imgH:0,objW:0,objH:0,actualRotation:0,windowW:0,windowH:$(e).height(),obj:{},outputDiv:{},outputUrlObj:{},img:{},defaultImg:{},croppedImg:{},imgEyecandy:{},form:{},cropControlsUpload:{},cropControlsCrop:{},cropControlZoomMuchIn:{},cropControlZoomMuchOut:{},cropControlZoomIn:{},cropControlZoomOut:{},cropControlCrop:{},cropControlReset:{},cropControlRemoveCroppedImage:{},modal:{},loader:{},init:function(){var e=this;e.objW=e.obj.width();e.objH=e.obj.height();e.actualRotation=0;if($.isEmptyObject(e.defaultImg)){e.defaultImg=e.obj.find("img")}e.createImgUploadControls();if($.isEmptyObject(e.options.loadPicture)){e.bindImgUploadControl()}else{e.loadExistingImage()}},createImgUploadControls:function(){var e=this;var t="";if(e.options.customUploadButtonId===""){t='<i class="cropControlUpload"></i>'}var n='<i class="cropControlRemoveCroppedImage"></i>';if($.isEmptyObject(e.croppedImg)){n=""}if(!$.isEmptyObject(e.options.loadPicture)){t=""}var r='<div class="cropControls cropControlsUpload"> '+t+n+" </div>";e.outputDiv.append(r);e.cropControlsUpload=e.outputDiv.find(".cropControlsUpload");if(e.options.customUploadButtonId===""){e.imgUploadControl=e.outputDiv.find(".cropControlUpload")}else{e.imgUploadControl=$("#"+e.options.customUploadButtonId);e.imgUploadControl.show()}if(!$.isEmptyObject(e.croppedImg)){e.cropControlRemoveCroppedImage=e.outputDiv.find(".cropControlRemoveCroppedImage")}},bindImgUploadControl:function(){var e=this;var n='<div class="'+e.id+'_imgUploadForm" style="position: absolute; visibility: hidden; top:0;">  <input type="file" name="img">  </div>';e.outputDiv.append(n);e.form=e.outputDiv.find("."+e.id+"_imgUploadForm");e.imgUploadControl.off("click");e.imgUploadControl.on("click",function(){e.form.find('input[type="file"]').trigger("click")});if(!$.isEmptyObject(e.croppedImg)){e.cropControlRemoveCroppedImage.on("click",function(){e.croppedImg.remove();$(this).hide();if(!$.isEmptyObject(e.defaultImg)){e.obj.append(e.defaultImg)}if(e.options.outputUrlId!==""){$("#"+e.options.outputUrlId).val("")}})}e.form.find('input[type="file"]').change(function(){if(e.options.onBeforeImgUpload)e.options.onBeforeImgUpload.call(e);e.showLoader();e.imgUploadControl.hide();var n=new FormData($("body").find('#register-form')[0]);for(var r in e.options.uploadData){if(e.options.uploadData.hasOwnProperty(r)){n.append(r,e.options.uploadData[r])}}$.ajax({url:e.options.uploadUrl,data:n,context:t.body,cache:false,contentType:false,processData:false,type:"POST"}).always(function(t){response=typeof t=="object"?t:jQuery.parseJSON(t);if(response.status=="success"){e.imgInitW=e.imgW=response.width;e.imgInitH=e.imgH=response.height;if(e.options.modal){e.createModal()}if(!$.isEmptyObject(e.croppedImg)){e.croppedImg.remove()}e.imgUrl=response.url;var n=$('<img src="'+response.url+'">');e.obj.append(n);n.load(function(){e.initCropper();e.hideLoader();if(e.options.onAfterImgUpload)e.options.onAfterImgUpload.call(e)})}if(response.status=="error"){if(e.options.onError)e.options.onError.call(e,response.message);e.hideLoader();setTimeout(function(){e.reset()},2e3)}})})},loadExistingImage:function(){var e=this;if($.isEmptyObject(e.croppedImg)){if(e.options.onBeforeImgUpload)e.options.onBeforeImgUpload.call(e);e.showLoader();if(e.options.modal){e.createModal()}if(!$.isEmptyObject(e.croppedImg)){e.croppedImg.remove()}e.imgUrl=e.options.loadPicture;var t=$('<img src="'+e.options.loadPicture+'">');e.obj.append(t);t.load(function(){e.imgInitW=e.imgW=this.width;e.imgInitH=e.imgH=this.height;e.initCropper();e.hideLoader();if(e.options.onAfterImgUpload)e.options.onAfterImgUpload.call(e)})}else{e.cropControlRemoveCroppedImage.on("click",function(){e.croppedImg.remove();$(this).hide();if(!$.isEmptyObject(e.defaultImg)){e.obj.append(e.defaultImg)}if(e.options.outputUrlId!==""){$("#"+e.options.outputUrlId).val("")}e.croppedImg="";e.reset()})}},createModal:function(){var e=this;var t=e.windowH/2-e.objH/2;var n='<div id="croppicModal">'+'<div id="croppicModalObj" style="width:'+e.objW+"px; height:"+e.objH+"px; margin:0 auto; margin-top:"+t+'px; position: relative;"> </div>'+"</div>";$("body").append(n);e.modal=$("#croppicModal");e.obj=$("#croppicModalObj")},destroyModal:function(){var e=this;e.obj=e.outputDiv;e.modal.remove()},initCropper:function(){var e=this;e.img=e.obj.find("img");e.img.wrap('<div class="cropImgWrapper" style="overflow:hidden; z-index:1; position:absolute; width:'+e.objW+"px; height:"+e.objH+'px;"></div>');e.createCropControls();if(e.options.imgEyecandy){e.createEyecandy()}e.initDrag();e.initialScaleImg()},createEyecandy:function(){var e=this;e.imgEyecandy=e.img.clone();e.imgEyecandy.css({"z-index":"0",opacity:e.options.imgEyecandyOpacity}).appendTo(e.obj)},destroyEyecandy:function(){var e=this;e.imgEyecandy.remove()},initialScaleImg:function(){var e=this;e.zoom(-e.imgInitW);e.zoom(40);if(e.options.enableMousescroll){e.img.on("mousewheel",function(t){t.preventDefault();e.zoom(e.options.zoomFactor*t.deltaY)})}e.img.css({left:-(e.imgW-e.objW)/2,top:-(e.imgH-e.objH)/2,position:"relative"});if(e.options.imgEyecandy){e.imgEyecandy.css({left:-(e.imgW-e.objW)/2,top:-(e.imgH-e.objH)/2,position:"relative"})}},createCropControls:function(){var e=this;var t="";var n='<i class="cropControlZoomIn"></i>';var r='<i class="cropControlZoomOut"></i>';var i="";var s="";var o="";var u='<i class="cropControlCrop"></i>';var a='<i class="cropControlReset"></i>';var f;if(e.options.doubleZoomControls){t='<i class="cropControlZoomMuchIn"></i>';i='<i class="cropControlZoomMuchOut"></i>'}if(e.options.rotateControls){s='<i class="cropControlRotateLeft"></i>';o='<i class="cropControlRotateRight"></i>'}f='<div class="cropControls cropControlsCrop">'+t+n+r+i+s+o+u+a+"</div>";e.obj.append(f);e.cropControlsCrop=e.obj.find(".cropControlsCrop");if(e.options.doubleZoomControls){e.cropControlZoomMuchIn=e.cropControlsCrop.find(".cropControlZoomMuchIn");e.cropControlZoomMuchIn.on("click",function(){e.zoom(e.options.zoomFactor*10)});e.cropControlZoomMuchOut=e.cropControlsCrop.find(".cropControlZoomMuchOut");e.cropControlZoomMuchOut.on("click",function(){e.zoom(-e.options.zoomFactor*10)})}e.cropControlZoomIn=e.cropControlsCrop.find(".cropControlZoomIn");e.cropControlZoomIn.on("click",function(){e.zoom(e.options.zoomFactor)});e.cropControlZoomOut=e.cropControlsCrop.find(".cropControlZoomOut");e.cropControlZoomOut.on("click",function(){e.zoom(-e.options.zoomFactor)});e.cropControlZoomIn=e.cropControlsCrop.find(".cropControlRotateLeft");e.cropControlZoomIn.on("click",function(){e.rotate(-e.options.rotateFactor)});e.cropControlZoomOut=e.cropControlsCrop.find(".cropControlRotateRight");e.cropControlZoomOut.on("click",function(){e.rotate(e.options.rotateFactor)});e.cropControlCrop=e.cropControlsCrop.find(".cropControlCrop");e.cropControlCrop.on("click",function(){e.crop()});e.cropControlReset=e.cropControlsCrop.find(".cropControlReset");e.cropControlReset.on("click",function(){e.reset()})},initDrag:function(){var t=this;t.img.on("mousedown touchstart",function(n){n.preventDefault();var r;var i;var s=e.navigator.userAgent;if(s.match(/iPad/i)||s.match(/iPhone/i)||s.match(/android/i)){r=n.originalEvent.touches[0].pageX;i=n.originalEvent.touches[0].pageY}else{r=n.pageX;i=n.pageY}var o=t.img.css("z-index"),u=t.img.outerHeight(),a=t.img.outerWidth(),f=t.img.offset().top+u-i,l=t.img.offset().left+a-r;t.img.css("z-index",1e3).on("mousemove touchmove",function(e){var n;var r;if(s.match(/iPad/i)||s.match(/iPhone/i)||s.match(/android/i)){n=e.originalEvent.touches[0].pageY+f-u;r=e.originalEvent.touches[0].pageX+l-a}else{n=e.pageY+f-u;r=e.pageX+l-a}t.img.offset({top:n,left:r}).on("mouseup",function(){$(this).removeClass("draggable").css("z-index",o)});if(t.options.imgEyecandy){t.imgEyecandy.offset({top:n,left:r})}if(t.objH<t.imgH){if(parseInt(t.img.css("top"))>0){t.img.css("top",0);if(t.options.imgEyecandy){t.imgEyecandy.css("top",0)}}var i=-(t.imgH-t.objH);if(parseInt(t.img.css("top"))<i){t.img.css("top",i);if(t.options.imgEyecandy){t.imgEyecandy.css("top",i)}}}else{if(parseInt(t.img.css("top"))<0){t.img.css("top",0);if(t.options.imgEyecandy){t.imgEyecandy.css("top",0)}}var i=t.objH-t.imgH;if(parseInt(t.img.css("top"))>i){t.img.css("top",i);if(t.options.imgEyecandy){t.imgEyecandy.css("top",i)}}}if(t.objW<t.imgW){if(parseInt(t.img.css("left"))>0){t.img.css("left",0);if(t.options.imgEyecandy){t.imgEyecandy.css("left",0)}}var c=-(t.imgW-t.objW);if(parseInt(t.img.css("left"))<c){t.img.css("left",c);if(t.options.imgEyecandy){t.imgEyecandy.css("left",c)}}}else{if(parseInt(t.img.css("left"))<0){t.img.css("left",0);if(t.options.imgEyecandy){t.imgEyecandy.css("left",0)}}var c=t.objW-t.imgW;if(parseInt(t.img.css("left"))>c){t.img.css("left",c);if(t.options.imgEyecandy){t.imgEyecandy.css("left",c)}}}if(t.options.onImgDrag)t.options.onImgDrag.call(t)})}).on("mouseup",function(){t.img.off("mousemove")}).on("mouseout",function(){t.img.off("mousemove")})},rotate:function(e){var t=this;t.actualRotation+=e;t.img.css({"-webkit-transform":"rotate("+t.actualRotation+"deg)","-moz-transform":"rotate("+t.actualRotation+"deg)",transform:"rotate("+t.actualRotation+"deg)"});if(t.options.imgEyecandy){t.imgEyecandy.css({"-webkit-transform":"rotate("+t.actualRotation+"deg)","-moz-transform":"rotate("+t.actualRotation+"deg)",transform:"rotate("+t.actualRotation+"deg)"})}if(typeof t.options.onImgRotate=="function")t.options.onImgRotate.call(t)},zoom:function(e){var t=this;var n=t.imgW/t.imgH;var r=t.imgW+e;var i=r/n;var s=true;if(r<t.objW||i<t.objH){if(r-t.objW<i-t.objH){r=t.objW;i=r/n}else{i=t.objH;r=n*i}s=false}if(!t.options.scaleToFill&&(r>t.imgInitW||i>t.imgInitH)){if(r-t.imgInitW<i-t.imgInitH){r=t.imgInitW;i=r/n}else{i=t.imgInitH;r=n*i}s=false}t.imgW=r;t.img.width(r);t.imgH=i;t.img.height(i);var o=parseInt(t.img.css("top"))-e/2;var u=parseInt(t.img.css("left"))-e/2;if(o>0){o=0}if(u>0){u=0}var a=-(i-t.objH);if(o<a){o=a}var f=-(r-t.objW);if(u<f){u=f}if(s){t.img.css({top:o,left:u})}if(t.options.imgEyecandy){t.imgEyecandy.width(r);t.imgEyecandy.height(i);if(s){t.imgEyecandy.css({top:o,left:u})}}if(t.options.onImgZoom)t.options.onImgZoom.call(t)},crop:function(){var e=this;if(e.options.onBeforeImgCrop)e.options.onBeforeImgCrop.call(e);e.cropControlsCrop.hide();e.showLoader();var n={imgUrl:e.imgUrl,imgInitW:e.imgInitW,imgInitH:e.imgInitH,imgW:e.imgW,imgH:e.imgH,imgY1:Math.abs(parseInt(e.img.css("top"))),imgX1:Math.abs(parseInt(e.img.css("left"))),cropH:e.objH,cropW:e.objW,rotation:e.actualRotation};var r=new FormData;for(var i in n){if(n.hasOwnProperty(i)){r.append(i,n[i])}}for(var i in e.options.cropData){if(e.options.cropData.hasOwnProperty(i)){r.append(i,e.options.cropData[i])}}$.ajax({url:e.options.cropUrl,data:r,context:t.body,cache:false,contentType:false,processData:false,type:"POST"}).always(function(t){response=typeof t=="object"?t:jQuery.parseJSON(t);if(response.status=="success"){if(e.options.imgEyecandy)e.imgEyecandy.hide();e.destroy();e.obj.append('<img class="croppedImg" src="'+response.url+'">');if(e.options.outputUrlId!==""){$("#"+e.options.outputUrlId).val(response.url)}e.croppedImg=e.obj.find(".croppedImg");e.init();e.hideLoader()}if(response.status=="error"){if(e.options.onError)e.options.onError.call(e,response.message);e.hideLoader();setTimeout(function(){e.reset()},2e3)}if(e.options.onAfterImgCrop)e.options.onAfterImgCrop.call(e)})},showLoader:function(){var e=this;e.obj.append(e.options.loaderHtml);e.loader=e.obj.find(".loader")},hideLoader:function(){var e=this;e.loader.remove()},reset:function(){var e=this;e.destroy();e.init();if(!$.isEmptyObject(e.croppedImg)){e.obj.append(e.croppedImg);if(e.options.outputUrlId!==""){$("#"+e.options.outputUrlId).val(e.croppedImg.attr("url"))}}if(typeof e.options.onReset=="function")e.options.onReset.call(e)},destroy:function(){var e=this;if(e.options.modal&&!$.isEmptyObject(e.modal)){e.destroyModal()}if(e.options.imgEyecandy&&!$.isEmptyObject(e.imgEyecandy)){e.destroyEyecandy()}if(!$.isEmptyObject(e.cropControlsUpload)){e.cropControlsUpload.remove()}if(!$.isEmptyObject(e.cropControlsCrop)){e.cropControlsCrop.remove()}if(!$.isEmptyObject(e.loader)){e.loader.remove()}if(!$.isEmptyObject(e.form)){e.form.remove()}e.obj.html("")}}})(window,document)